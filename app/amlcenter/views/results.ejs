<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matching Results - LBCFT Sanctions Matching Tool</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4 text-center">Matching Results</h1>
    
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Summary</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <div class="alert alert-info">
              <p><strong>Excel Entries:</strong> <%= excelData.length %></p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="alert alert-info">
              <p><strong>Sanctions Entries:</strong> <%= pdfData.length %></p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="alert <%= matchResults.some(r => r.bestMatchScore > 0.7) ? 'alert-danger' : 'alert-success' %>">
              <p><strong>Potential Matches:</strong> <%= matchResults.filter(r => r.bestMatchScore > 0.7).length %></p>
            </div>
          </div>
        </div>
        <a href="/" class="btn btn-secondary mt-2">Back to Home</a>
        <button class="btn btn-primary mt-2 ms-2" onclick="window.print()">Print Results</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Matching Results</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Excel Name</th>
                <th>Match Status</th>
                <th>Best Match</th>
                <th>Match Score</th>
                <th>Match Details</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% matchResults.forEach((result, index) => { %>
                <tr class="<%= result.bestMatchScore > 0.7 ? 'table-danger' : result.bestMatchScore > 0.5 ? 'table-warning' : 'table-success' %>">
                  <td>
                    <%= result.excelEntry.name || result.excelEntry.Name || 'N/A' %>
                    <% if (result.excelEntry.dateOfBirth || result.excelEntry.DateOfBirth || result.excelEntry.DOB || result.excelEntry.dob) { %>
                      <br><small class="text-muted">DOB: <%= result.excelEntry.dateOfBirth || result.excelEntry.DateOfBirth || result.excelEntry.DOB || result.excelEntry.dob %></small>
                    <% } %>
                    <% if (result.excelEntry.nationality || result.excelEntry.Nationality) { %>
                      <br><small class="text-muted">Nationality: <%= result.excelEntry.nationality || result.excelEntry.Nationality %></small>
                    <% } %>
                  </td>
                  <td>
                    <% if (result.bestMatchScore > 0.9) { %>
                      <span class="badge bg-danger">High Risk Match</span>
                    <% } else if (result.bestMatchScore > 0.7) { %>
                      <span class="badge bg-warning text-dark">Potential Match</span>
                    <% } else if (result.bestMatchScore > 0.5) { %>
                      <span class="badge bg-info text-dark">Low Similarity</span>
                    <% } else { %>
                      <span class="badge bg-success">No Match</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (result.bestMatch) { %>
                      <%= result.bestMatch.name %>
                      <br><small class="text-muted"><%= result.bestMatch.id %></small>
                    <% } else { %>
                      None
                    <% } %>
                  </td>
                  <td>
                    <% if (result.bestMatchScore > 0) { %>
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar <%= result.bestMatchScore > 0.7 ? 'bg-danger' : result.bestMatchScore > 0.5 ? 'bg-warning' : 'bg-success' %>" 
                             role="progressbar" 
                             style="width: <%= Math.min(100, result.bestMatchScore * 100) %>%" 
                             aria-valuenow="<%= Math.round(result.bestMatchScore * 100) %>" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                          <%= Math.round(result.bestMatchScore * 100) %>%
                        </div>
                      </div>
                      <% if (result.matches && result.matches[0]) { %>
                        <small>
                          <% if (result.matches[0].nameScore) { %>Name: <%= Math.round(result.matches[0].nameScore * 100) %>%<% } %>
                          <% if (result.matches[0].dobScore) { %> | DOB: <%= Math.round(result.matches[0].dobScore * 100) %>%<% } %>
                          <% if (result.matches[0].nationalityScore) { %> | Nat: <%= Math.round(result.matches[0].nationalityScore * 100) %>%<% } %>
                        </small>
                      <% } %>
                    <% } else { %>
                      N/A
                    <% } %>
                  </td>
                  <td>
                    <% if (result.bestMatch) { %>
                      <% if (result.bestMatch.aliases && result.bestMatch.aliases.length > 0) { %>
                        <small>Aliases: <%= result.bestMatch.aliases.length %></small><br>
                      <% } %>
                      <% if (result.bestMatch.dateOfBirth) { %>
                        <small>DOB: <%= result.bestMatch.dateOfBirth %></small><br>
                      <% } %>
                      <% if (result.bestMatch.nationality) { %>
                        <small>Nationality: <%= result.bestMatch.nationality %></small>
                      <% } %>
                    <% } else { %>
                      N/A
                    <% } %>
                  </td>
                  <td>
                    <% if (result.bestMatch) { %>
                      <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#matchModal<%= index %>">
                        View Details
                      </button>
                    <% } %>
                  </td>
                </tr>
                
                <% if (result.bestMatch) { %>
                  <!-- Modal for match details -->
                  <div class="modal fade" id="matchModal<%= index %>" tabindex="-1" aria-labelledby="matchModalLabel<%= index %>" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                      <div class="modal-content">
                        <div class="modal-header <%= result.bestMatchScore > 0.7 ? 'bg-danger text-white' : 'bg-info' %>">
                          <h5 class="modal-title" id="matchModalLabel<%= index %>">
                            Match Details: <%= result.excelEntry.name || result.excelEntry.Name %>
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row">
                            <div class="col-md-6">
                              <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                  <h6 class="mb-0">Excel Data</h6>
                                </div>
                                <div class="card-body">
                                  <table class="table table-bordered">
                                    <tbody>
                                      <% Object.keys(result.excelEntry).forEach(key => { %>
                                        <tr>
                                          <th><%= key %></th>
                                          <td><%= result.excelEntry[key] %></td>
                                        </tr>
                                      <% }); %>
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-6">
                              <div class="card">
                                <div class="card-header bg-danger text-white">
                                  <h6 class="mb-0">Sanctions Data</h6>
                                </div>
                                <div class="card-body">
                                  <p><strong>ID:</strong> <%= result.bestMatch.id %></p>
                                  <p><strong>Name:</strong> <%= result.bestMatch.name %></p>
                                  
                                  <% if (result.bestMatch.nameComponents && result.bestMatch.nameComponents.length > 0) { %>
                                    <p><strong>Composants du nom:</strong></p>
                                    <ul>
                                      <% result.bestMatch.nameComponents.forEach(component => { %>
                                        <li><%= component.number %>: <%= component.value %></li>
                                      <% }); %>
                                    </ul>
                                  <% } %>
                                  
                                  <% if (result.bestMatch.originalScript) { %>
                                    <p><strong>Nom (alphabet d'origine):</strong> <%= result.bestMatch.originalScript %></p>
                                  <% } %>
                                  
                                  <% if (result.bestMatch.type === 'entity') { %>
                                    <!-- Entity specific fields -->
                                    <% if (result.bestMatch.otherNames && result.bestMatch.otherNames.length > 0) { %>
                                      <p><strong>Autre(s) nom(s) connu(s):</strong></p>
                                      <ul>
                                        <% result.bestMatch.otherNames.forEach(name => { %>
                                          <li><%= name %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <% if (result.bestMatch.previouslyKnownAs && result.bestMatch.previouslyKnownAs.length > 0) { %>
                                      <p><strong>Précédemment connu(e) sous le nom de:</strong></p>
                                      <ul>
                                        <% result.bestMatch.previouslyKnownAs.forEach(name => { %>
                                          <li><%= name %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <!-- Improved address display to handle array format for entities -->
                                    <% if (result.bestMatch.address) { %>
                                      <% if (Array.isArray(result.bestMatch.address) && result.bestMatch.address.length > 0) { %>
                                        <p><strong>Adresse:</strong></p>
                                        <ul>
                                          <% result.bestMatch.address.forEach((addr, index) => { %>
                                            <li><%= String.fromCharCode(97 + index) %>) <%= addr %></li>
                                          <% }); %>
                                        </ul>
                                      <% } else { %>
                                        <p><strong>Adresse:</strong> N/A</p>
                                      <% } %>
                                    <% } else { %>
                                      <p><strong>Adresse:</strong> N/A</p>
                                    <% } %>
                                    <p><strong>Date d'inscription:</strong> <%= result.bestMatch.listedOn || 'N/A' %></p>
                                    <p><strong>Renseignements divers:</strong> <%= result.bestMatch.otherInfo || 'N/A' %></p>
                                  <% } else { %>
                                    <!-- Person specific fields -->
                                    <% if (result.bestMatch.otherNames && result.bestMatch.otherNames.length > 0) { %>
                                      <p><strong>Autre(s) nom(s) connu(s):</strong></p>
                                      <ul>
                                        <% result.bestMatch.otherNames.forEach(name => { %>
                                          <li><%= name %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <% if (result.bestMatch.previouslyKnownAs && result.bestMatch.previouslyKnownAs.length > 0) { %>
                                      <p><strong>Précédemment connu(e) sous le nom de:</strong></p>
                                      <ul>
                                        <% result.bestMatch.previouslyKnownAs.forEach(name => { %>
                                          <li><%= name %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <p><strong>Titre:</strong> <%= result.bestMatch.title || 'N/A' %></p>
                                    <p><strong>Désignation:</strong> <%= result.bestMatch.designation || 'N/A' %></p>
                                    <p><strong>Date de naissance:</strong> <%= result.bestMatch.dateOfBirth || 'N/A' %></p>
                                    <p><strong>Lieu de naissance:</strong> <%= result.bestMatch.placeOfBirth || 'N/A' %></p>
                                    
                                    <% if (result.bestMatch.reliableAlias && result.bestMatch.reliableAlias.length > 0) { %>
                                      <p><strong>Pseudonyme fiable:</strong></p>
                                      <ul>
                                        <% result.bestMatch.reliableAlias.forEach(alias => { %>
                                          <li><%= alias %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <% if (result.bestMatch.unreliableAlias && result.bestMatch.unreliableAlias.length > 0) { %>
                                      <p><strong>Pseudonyme peu fiable:</strong></p>
                                      <ul>
                                        <% result.bestMatch.unreliableAlias.forEach(alias => { %>
                                          <li><%= alias %></li>
                                        <% }); %>
                                      </ul>
                                    <% } %>
                                    
                                    <% if (result.bestMatch.gender) { %>
                                      <p><strong>Genre:</strong> <%= result.bestMatch.gender %></p>
                                    <% } %>
                                    <p><strong>Nationalité:</strong> <%= result.bestMatch.nationality || 'N/A' %></p>
                                    <p><strong>Numéro de passeport:</strong> <%= result.bestMatch.passportNo || 'N/A' %></p>
                                    <p><strong>Numéro national d'identification:</strong> <%= result.bestMatch.nationalId || 'N/A' %>
                                    
                                    <% if (result.bestMatch.documents && result.bestMatch.documents.length > 0) { %>
                                      <p><strong>Documents d'identification:</strong></p>
                                      <ul class="list-group">
                                        <% result.bestMatch.documents.forEach((doc, index) => { %>
                                          <li class="list-group-item">
                                            <strong>Document <%= index + 1 %>:</strong>
                                            <% if (doc.type || doc.type2) { %>
                                              <div><strong>Type:</strong> <%= doc.type %><%= doc.type2 ? ', ' + doc.type2 : '' %></div>
                                            <% } %>
                                            <% if (doc.number) { %>
                                              <div><strong>Numéro:</strong> <%= doc.number %></div>
                                            <% } %>
                                            <% if (doc.countryOfIssue) { %>
                                              <div><strong>Pays d'émission:</strong> <%= doc.countryOfIssue %></div>
                                            <% } %>
                                            <% if (doc.dateOfIssue) { %>
                                              <div><strong>Date d'émission:</strong> <%= doc.dateOfIssue %></div>
                                            <% } %>
                                            <% if (doc.cityOfIssue) { %>
                                              <div><strong>Ville d'émission:</strong> <%= doc.cityOfIssue %></div>
                                            <% } %>
                                            <% if (doc.note) { %>
                                              <div><strong>Note:</strong> <%= doc.note %></div>
                                            <% } %>
                                          </li>
                                        <% }); %>
                                      </ul>
                                    <% } %></p>
                                    
                                    <!-- Improved address display to handle array format -->
                                    <% if (result.bestMatch.address && result.bestMatch.address.length > 0) { %>
                                      <p><strong>Adresse:</strong></p>
                                      <ul>
                                        <% result.bestMatch.address.forEach((addr, index) => { %>
                                          <li><%= String.fromCharCode(97 + index) %>) <%= addr %></li>
                                        <% }); %>
                                      </ul>
                                    <% } else { %>
                                      <p><strong>Adresse:</strong> N/A</p>
                                    <% } %>
                                    
                                    <p><strong>Date d'inscription:</strong> <%= result.bestMatch.listedOn || 'N/A' %></p>
                                    <% if (result.bestMatch.lastUpdated) { %>
                                      <p><strong>Dernière mise à jour:</strong> <%= result.bestMatch.lastUpdated %></p>
                                    <% } %>
                                    <% if (result.bestMatch.physicalDescription) { %>
                                      <p><strong>Description physique:</strong> <%= result.bestMatch.physicalDescription %></p>
                                    <% } %>
                                    <% if (result.bestMatch.languages) { %>
                                      <p><strong>Langues parlées:</strong> <%= result.bestMatch.languages %></p>
                                    <% } %>
                                    <% if (result.bestMatch.interpol) { %>
                                      <p><strong>Notice INTERPOL:</strong> <%= result.bestMatch.interpol %></p>
                                    <% } %>
                                    <% if (result.bestMatch.resolution) { %>
                                      <p><strong>Résolution:</strong> <%= result.bestMatch.resolution %></p>
                                    <% } %>
                                    <p><strong>Renseignements divers:</strong> <%= result.bestMatch.otherInfo || 'N/A' %></p>
                                  <% } %>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          <div class="alert alert-info mt-3">
                            <h6>Match Analysis:</h6>
                            <p>
                              <strong>Overall Match Score:</strong> <%= Math.round(result.bestMatchScore * 100) %>%<br>
                              <% if (result.matches && result.matches[0]) { %>
                                <% if (result.matches[0].nameScore) { %>
                                  <strong>Name Similarity:</strong> <%= Math.round(result.matches[0].nameScore * 100) %>%<br>
                                <% } %>
                                <% if (result.matches[0].dobScore) { %>
                                  <strong>Date of Birth Match:</strong> <%= Math.round(result.matches[0].dobScore * 100) %>%<br>
                                <% } %>
                                <% if (result.matches[0].nationalityScore) { %>
                                  <strong>Nationality Match:</strong> <%= Math.round(result.matches[0].nationalityScore * 100) %>%
                                <% } %>
                              <% } %>
                            </p>
                            <div class="progress mt-2" style="height: 25px;">
                              <div class="progress-bar <%= result.bestMatchScore > 0.7 ? 'bg-danger' : result.bestMatchScore > 0.5 ? 'bg-warning' : 'bg-success' %>" 
                                   role="progressbar" 
                                   style="width: <%= Math.min(100, result.bestMatchScore * 100) %>%" 
                                   aria-valuenow="<%= Math.round(result.bestMatchScore * 100) %>" 
                                   aria-valuemin="0" 
                                   aria-valuemax="100">
                                <%= Math.round(result.bestMatchScore * 100) %>%
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% } %>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>