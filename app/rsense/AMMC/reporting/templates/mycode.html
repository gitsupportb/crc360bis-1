{% load static %}
          <!DOCTYPE html>
          <html lang="fr">
          <head>
            <meta charset="UTF-8">
            <title>Reporting Dashboard AMMC</title>
            <style>  
          
          /* Header */
          header {
              font-family: 'Times New Roman', serif;
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 04px 30px;
              background-color: #fff;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          
          }
          
          nav ul {
              list-style: none;
              display: flex;
              gap: 20px;
              padding: 0;
          
          }
          
          nav ul li {
              display: inline;
          
          }
          
          nav ul li a {
              text-decoration: none;
              color: #333;
              font-weight: bold;
          }
          
          
          /* Conteneur des cartes */
          .reporting-container {
              display: flex;
              gap: 20px;
              justify-content: space-between;
          }
          
          /* Style des cartes */
          .reporting-card {
             font-family: 'Times New Roman', serif;
              flex: 1;
              background-color: rgb(255, 255, 255);
              padding: 04px;
              border-radius: 8px;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              text-align: center;
              min-width: 100px;
              margin-top: -10px;
              margin-bottom:2%;
          }
          
          .reporting-card h2 {
              font-size: 20px;
              color: #555;
          }
          
          .reporting-card .number {
              font-size: 16px;
              font-weight: bold;
              color: #333;
          }
          
          .reporting-card span {
              display: block;
              font-size: 12px;
              color: #777;
          }
          
            #logo {
              max-width: 100%;
              height: auto;
            }
              body {
                font-family: 'Verdana', sans-serif; /* Police modifiée */
                background-color: #ffffff;/* Beige clair */
                margin: 20px;
              }
              h1 {
                text-align: center;
                font-size: 35px;
                color: #e66c09; /* Marron foncé title */
                font-family: 'Times New Roman', serif;
              }
              /* Top‑level tabs */
              .top-tabs {
                overflow: hidden;
                margin-top:0%;
                border-bottom: 1px solid #d8ad89; /* Orange foncé */
                background-color: #faf6f2; /* Beige clair */
                margin-bottom: 20px;
              }
              .top-tablinks {
                background-color: inherit;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 12px 16px;
                transition: background-color 0.3s;
                font-size: 16px;
                color: #703c12; /* Marron clair */
              }
              .top-tablinks:hover {
                background-color: rgb(228, 221, 215); /* Orange plus clair au survol */
              }
              .top-tablinks.active {
                background-color: #e66c09; /* Couleur orange active */
                color: white;
              }
              .top-tabcontent {
                display: none;
                padding: 10px 15px;
                border: 1px solid #f5b66f; /* Orange clair */
                background-color: #ffffff;
                margin-bottom: 20px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
              }
              /* Nested (sub‑) tabs */
              .sub-tabs {
                overflow: hidden;
                border-bottom: 1px solid #a76f3e; /* Marron clair */
                background-color: #fff8e0; /* Beige très clair */
                margin-bottom: 10px;
              }
              .sub-tablinks {
                background-color: inherit;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 10px 14px;
                transition: background-color 0.3s;
                font-size: 14px;
                color: #703c12; /* Marron clair */
              }
              .sub-tablinks:hover {
                background-color: rgb(228, 221, 215); /* Orange plus clair au survol */
              }
              .sub-tablinks.active {
                background-color: #e66c09; /* Couleur orange active */
                color: white;
              }
              .sub-tabcontent {
                display: none;
                padding: 8px 10px;
                border: 1px solid #d18f3d; /* Orange clair */
                background-color: #ffffff;
                margin-bottom: 10px;
              }         
         
              /* Table styling */
              table {
                width: 100%;
                font-family: 'Times New Roman', serif;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 16px;
                background-color: #ffffff;
                border: 1px solid #d18f3d;
              }
              th, td {
                border: 1px solid #d18f3d; /* Marron clair */
                padding: 6px 8px;
                text-align: left;
              }
              th {
                background-color: #fff9e7; /* Beige clair pour les en-têtes */
              }
              .toggle-checkbox {
                transform: scale(1.2);
              }
              /* Plotly container */
              .progress-chart {
                width: 100%;
                border:1px solid #d18f3d;
                height: 400px;
                margin-bottom: 20px;
              }
         
          .freq-monthly {
              font-weight: bold;
              display: flex;
              justify-content: space-around;
              width: 75%;
              margin-top: 10%;
              margin-right: 10%;
              margin-bottom:10%;
              text-align: center;
              vertical-align: middle; /* Centre le contenu verticalement */
              padding: 5px 10px;  /* Espace interne */
              border-radius: 50px;  /* Bords arrondis */
              color: rgb(212, 123, 64);  /* Texte en blanc */;
              display: inline-block;  /* Permet d’avoir une largeur ajustée au texte */
              background-color: #ffffff;
              justify-content: center; /* Centre horizontalement */
              align-items: center; /* Centre verticalement */
          }
          
          .freq-semester{
              font-weight: bold;
              margin-top: 10%;
              margin-right: 10%;
              margin-bottom:10%;
              text-align: center; /* Centre le contenu horizontalement */
              vertical-align: middle; /* Centre le contenu verticalement */
              padding: 5px 10px;  /* Espace interne */
              border-radius: 50px;  /* Bords arrondis */
              color: rgb(107, 107, 107);  /* Texte en blanc */;
              display: inline-block;  /* Permet d’avoir une largeur ajustée au texte */
              background-color: rgb(255, 255, 255);
              justify-content: center; /* Centre horizontalement */
              align-items: center; /* Centre verticalement */
          }
          
          .freq-annual {
            font-weight: bold;
              margin-top: 10%;
              margin-right: 10%;
              margin-bottom:10%;
              width:80%;
              text-align: center; /* Centre le contenu horizontalement */
              vertical-align: middle; /* Centre le contenu verticalement */
              padding: 5px 10px;  /* Espace interne */
              border-radius: 50px;  /* Bords arrondis */
              color: rgb(201, 165, 99);  /* Texte en blanc */;
              display: inline-block;  /* Permet d’avoir une largeur ajustée au texte */
              background-color: rgb(255, 255, 255);
              justify-content: center; /* Centre horizontalement */
              align-items: center; /* Centre verticalement */
          }
          
          .freq-trimestre{
            font-weight: bold;
              margin-top: 10%;
              margin-right: 10%;
              margin-bottom:10%;
              border-color:rgb(255, 174, 0);
              width:80%;
              text-align: center; /* Centre le contenu horizontalement */
              vertical-align: middle; /* Centre le contenu verticalement */
              padding: 5px 10px;  /* Espace interne */
              border-radius: 50px;  /* Bords arrondis */
              color: rgb(54, 54, 54);  /* Texte en blanc */;
              display: inline-block;  /* Permet d’avoir une largeur ajustée au texte */
              background-color: rgb(253, 253, 253);
              justify-content: center; /* Centre horizontalement */
              align-items: center; /* Centre verticalement */
          
          }
          .freq-hebdomadaire {
              font-weight: bold;
              display: flex;
              justify-content: space-around;
              width: 75%;
              margin-top: 10%;
              margin-right: 10%;
              margin-bottom:10%;
              text-align: center;
              vertical-align: middle; /* Centre le contenu verticalement */
              padding: 5px 10px;  /* Espace interne */
              border-radius: 50px;  /* Bords arrondis */
              color: rgba(138, 117, 103, 0.986);  /* Texte en blanc */;
              display: inline-block;  /* Permet d’avoir une largeur ajustée au texte */
              background-color: #fcfcfc;
              justify-content: center; /* Centre horizontalement */
              align-items: center; /* Centre verticalement */
          }
          .freq-default {
            background-color: white;
          }
          
          /* Module d'upload simplifié */
          #uploadSection {
            max-width: 10000px;
            height: 10%;
            max-height:100px;
            padding: 10px;
            margin: 30px ;
            margin-bottom:0%;
            padding: 8px;
            display: flex;
            flex-direction: line;
          }
          
          /* Titre */
          .upload-title {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #a39f9f; /* Marron foncé title */
            text-align: center;
            margin-top: -2%;
            margin-right: 20px;
            font-size: 20px ; /* Agrandir la taille du texte */
          }
          
          /* Champs */
          .upload-field {
            width: 100%;
            font-family: 'Times New Roman', serif;
            margin-bottom: 0px;
          }
          
          .upload-label {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #4c2d14;
            font-size: 18px; /* Agrandir la taille du texte */
          }
          
          .upload-select, .upload-input {
            width: 50%;
            height: 8%;
            margin-top:0%;
            margin-right:20px;
            padding: 8px;
            border: 2px solid #d18f3d;
            font-family: 'Times New Roman', serif;
            border-radius: 3px;
            background-color: #f9f9f9;
            font-size: 16px; /* Agrandir la taille du texte */
          }
          
          /* Conteneur des boutons */
          .upload-buttons {
            display: flex;
            justify-content: space-around;
            width: 50%;
            margin-bottom: 2px;
            font-family: 'Times New Roman', serif;
            margin-right: 10px;
          }
          
          .upload-btn {
              background-color: #d8672f; /* Orange moyen */
              color: white;
              margin-top: -1px;
              font-size: 16px;
              height: 40px;
              margin-right: 10px;
              padding: 08px 10px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              transition: background-color 0.3s, transform 0.2s;
              font-family: 'Times New Roman', serif;
              font-weight: bold;
          }
          
          .upload-btn:hover {
            background-color: #9b3201;
          }
          
          /* Status */
          #uploadStatus {
            margin-top: 5px;
            font-size: 12px;
            color: #333;
            font-family: 'Times New Roman', serif;
            text-align: center;
          }
          
          </style>
            <!-- Include Plotly.js -->
            <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

            
          </head>
          <body>
            
           
            <h1>Reporting Dashboard AMMC</h1>
            <!-- Sélecteur d'année -->
            <div style="text-align: center; margin-bottom: 20px;">
              <label for="yearSelector">Sélectionnée l'année :  </label>
              <select id="yearSelector">
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
              </select>
              <button id="updateYearButton">Mettre à jour l'année</button>
            </div>
          
           <!-- Module d'upload -->
          <div id="uploadSection">
            <h2 class="upload-title"></h2>
          
            <label for="reportSelect" class="upload-label">Rapport: </label>
            <select id="reportSelect" class="upload-select">
              <!-- Options ajoutées dynamiquement -->
            </select>
            <br><br>
          
            <!-- Sélecteur de mois -->
            <label for="monthSelect" class="upload-label">Mois: </label>
            <select id="monthSelect" class="upload-select">
              <option value="1">Janvier</option>
              <option value="2">Février</option>
              <option value="3">Mars</option>
              <option value="4">Avril</option>
              <option value="5">Mai</option>
              <option value="6">Juin</option>
              <option value="7">Juillet</option>
              <option value="8">Août</option>
              <option value="9">Septembre</option>
              <option value="10">Octobre</option>
              <option value="11">Novembre</option>
              <option value="12">Décembre</option>
            </select>
            <br><br>
          
            <label for="fileInput" class="upload-label">Fichier: </label>
            <input type="file" id="fileInput" class="upload-input">
            <br><br>
          
            <button id="uploadButton" class="upload-btn">Téléchargement</button>
            <span id="uploadStatus"></span>
          </div>
          
          
          <main>
            <section id="reporting">
                <h1></h1>
          
                <div class="reporting-container">
                    <div class="reporting-card">
                        <h2>Reportings du Mois</h2>
                        <p class="number" id="reportings-du-mois">0</p>
          
                        <span>À soumettre ce mois</span>
                    </div>
                    <div class="reporting-card">
                        <h2>Reportings Soumis</h2>
                        <p class="number" id="reportings-soumis">0</p>
                        <span>Dans les délais</span>
                    </div>
                    <div class="reporting-card">
                        <h2>En Cours</h2>
                        <p class="number" id="en-cours">0</p>
                        <span>En préparation</span>
                    </div>
                    <div class="reporting-card">
                        <h2>Échéances Proches</h2>
                        <p class="number" id="echeances-proches">0</p>
                        <span>Dans les 7 jours</span>
                    </div>
                </div>
            </section>
          </main>
            
            <!-- Onglets principaux -->
          <div class="top-tabs">
            <button class="top-tablinks" onclick="openTopTab(event, 'cat1')" id="defaultTopTab"><strong>I – Reporting AMMC BCP</strong></button>
            <button class="top-tablinks" onclick="openTopTab(event, 'cat2')"><strong>II – Reporting AMMC BCP2S</strong></button>
            <button class="top-tablinks" onclick="openTopTab(event, 'cat3')"><strong>III – Reporting AMMC ALYOUSR</strong></button>

          </div>
          
            
            <!-- CATEGORY I -->
            <div id="cat1" class="top-tabcontent">
              <div class="sub-tabs">
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat1_upcoming')" id="defaultSubTab_cat1">Evenements future</button>
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat1_reports')">tous les rapports</button>
              </div>
              <style>
                /* Applique un texte en gras pour les boutons des sous-onglets */
                .sub-tablinks {
                  font-weight: bold;
                }
              </style>
              <div id="cat1_upcoming" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Appellation</th>
                      <th>Frequency</th>
                      <th>Transmission</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                    </tr>
                  </thead>
                  <tbody id="upcoming-table-cat1">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
              <div id="cat1_reports" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Appellation</th>
                      <th>Frequency</th>
                      <th>Transmission</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                      <th>Toggle</th>
                      <th>Progress (%)</th>
                    </tr>
                  </thead>
                  <tbody id="reports-table-cat1">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- CATEGORY II -->
            <div id="cat2" class="top-tabcontent">
              <div class="sub-tabs">
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat2_upcoming')" id="defaultSubTab_cat2">Evenements future</button>
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat2_reports')">tous les rapports</button>
              </div>
              <div id="cat2_upcoming" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Appellation</th>
                      <th>Frequency</th>
                      <th>Transmission</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                    </tr>
                  </thead>
                  <tbody id="upcoming-table-cat2">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
              <div id="cat2_reports" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>Code</th>
                      <th>Appellation</th>
                      <th>Frequency</th>
                      <th>Transmission</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                      <th>Toggle</th>
                      <th>Progress (%)</th>
                    </tr>
                  </thead>
                  <tbody id="reports-table-cat2">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- CATEGORY III -->
            <div id="cat3" class="top-tabcontent">
              <div class="sub-tabs">
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat3_upcoming')" id="defaultSubTab_cat3">Evenements future</button>
                <button class="sub-tablinks" onclick="openSubTab(event, 'cat3_reports')">tous les rapports</button>
              </div>
          
          
              <div id="cat3_upcoming" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Reporting Name</th>
                      <th>Frequency</th>
                      <th>Submission Method</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                    </tr>
                  </thead>
                  <tbody id="upcoming-table-cat3">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
              <div id="cat3_reports" class="sub-tabcontent">
                <h2></h2>
                <table>
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Reporting Name</th>
                      <th>Frequency</th>
                      <th>Submission Method</th>
                      <th>Deadline Rule</th>
                      <th>Date d’arrêté</th>
                      <th>Deadline</th>
                      <th>Days Remaining</th>
                      <th>Toggle</th>
                      <th>Progress (%)</th>
                    </tr>
                  </thead>
                  <tbody id="reports-table-cat3">
                    <!-- Lignes générées dynamiquement -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- PROGRESSION OVERVIEW -->
            <div id="progressAll" class="top-tabcontent">
              <h2>Progression Overview (Yearly Completion %)</h2>
              <div id="progress-bars-cat1" class="progress-chart"></div>
              <div id="progress-bars-cat2" class="progress-chart"></div>
              <div id="progress-bars-cat3" class="progress-chart"></div>
            </div>
            
            <!-- JavaScript Code -->
            <script>
              /* ---------- Fonctions d'onglets ---------- */
              function openTopTab(evt, tabName) {
                var contents = document.getElementsByClassName("top-tabcontent");
                for (var i = 0; i < contents.length; i++) { contents[i].style.display = "none"; }
                var links = document.getElementsByClassName("top-tablinks");
                for (var i = 0; i < links.length; i++) { links[i].className = links[i].className.replace(" active", ""); }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
              }
              function openSubTab(evt, subTabName) {
                var container = evt.currentTarget.parentNode.parentNode;
                var contents = container.getElementsByClassName("sub-tabcontent");
                for (var i = 0; i < contents.length; i++) { contents[i].style.display = "none"; }
                var links = container.getElementsByClassName("sub-tablinks");
                for (var i = 0; i < links.length; i++) { links[i].className = links[i].className.replace(" active", ""); }
                document.getElementById(subTabName).style.display = "block";
                evt.currentTarget.className += " active";
              }
              document.getElementById("defaultTopTab").click();


              
              /* ---------- Fonctions utilitaires ---------- */
              function addDays(date, days) {
  var result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}

function getLastDayOfMonth(year, month) {
  return new Date(year, month, 0);
}

function monthNameToNumber(monthName) {
  monthName = monthName.toLowerCase();
  var months = {
    'janvier': 1, 'février': 2, 'fevrier': 2, 'mars': 3, 'avril': 4, 'mai': 5, 
    'juin': 6, 'juillet': 7, 'août': 8, 'aout': 8, 'septembre': 9, 'octobre': 10, 
    'novembre': 11, 'décembre': 12, 'decembre': 12
  };
  return months[monthName];
}

function parseFixedDeadline(rule, repDate) {
  var matches = [];
  var regex = /(?:(\d{1,2})|fin)\s*(janvier|février|fevrier|mars|avril|mai|juin|juillet|août|aout|septembre|octobre|novembre|décembre|decembre)/gi;
  var m;
  while ((m = regex.exec(rule)) !== null) {
    var day;
    var monthNumber = monthNameToNumber(m[2]);
    if (m[1]) { 
      day = parseInt(m[1]); 
    } else { 
      day = new Date(repDate.getFullYear(), monthNumber + 1, 0).getDate(); 
    }
    var candidate = new Date(repDate.getFullYear(), monthNumber - 1, day);
    if (candidate < repDate) { 
      candidate = new Date(repDate.getFullYear() + 1, monthNumber - 1, day); 
    }
    matches.push(candidate);
  }
  if (matches.length === 0) return null;
  matches.sort(function(a, b) { return a - b; });
  for (var i = 0; i < matches.length; i++){
    if (matches[i] >= repDate) return matches[i];
  }
  return matches[0];
}

function calculateDeadline(repDate, rule) {
  rule = rule.toLowerCase(); 
  // Adaptation pour les règles spécifiques : 5 jours, 10 jours et 1 mois
  if (rule.includes("5 jours")) return addDays(repDate, 5);
  if (rule.includes("10 jours")) return addDays(repDate, 10);
  if (rule.includes("un mois")) return addDays(repDate, 30); // approximativement 1 mois
  
  var fixed = parseFixedDeadline(rule, repDate);
  if (fixed) return fixed;
  return null;
}

function formatDate(date) {
  if (!(date instanceof Date)) return "N/A";
  var day = ("0" + date.getDate()).slice(-2);
  var month = ("0" + (date.getMonth() + 1)).slice(-2);
  var year = date.getFullYear();
  return day + "/" + month + "/" + year;
}
              
             /* ---------- Données ---------- */
             const dataCat1 = [
                { Code: "001", Appellation: "Rapport de contrôle des OPCVM", Frequency: "Hebdomadaire", Transmission: "SESAM", DeadlineRule: "Deuxième jour ouvré qui suit le vendredi de chaque semaine (mardi maximum)" },
                { Code: "002", Appellation: "Notifications des opérations de prêts de titres", Frequency: "Mensuelle", Transmission: "SESAM", DeadlineRule: "5 jours après la fin du mois" },
                { Code: "003", Appellation: "Annexe de pogramme de rachat", Frequency: "Mensuelle", Transmission: "Envoi électronique", DeadlineRule: "5 jours après la fin du mois" },
                { Code: "004", Appellation: "Transactions boursières", Frequency: "Mensuelle", Transmission: "Envoi électronique", DeadlineRule: "5 jours après la fin du mois" },
                { Code: "005", Appellation: "Répartition des souscripteurs actions ou parts OPCVM", Frequency: "Mensuelle", Transmission: "SESAM", DeadlineRule: "10 jours après la fin du mois" },
                { Code: "006", Appellation: "Indicateurs d'activité ", Frequency: "Trimestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du trimestre" },
                { Code: "007", Appellation: "Liste des titres détenus par les étrangers et MRE", Frequency: "Semestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du semestre" },
                { Code: "008", Appellation: "Rapport du contrôle interne", Frequency: "Semestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du semestre" },
               
              ];
             
          
              const dataCat2 = [
                { Code: "009", Appellation: "Notifications des opérations de prêts de titres", Frequency: "Mensuelle", Transmission: "SESAM", DeadlineRule: "5 jours après la fin du mois" },
                { Code: "010", Appellation: "Transactions boursières", Frequency: "Mensuelle", Transmission: "Envoi électronique", DeadlineRule: "5 jours après la fin du mois" },
                { Code: "011", Appellation: "Indicateurs d'activité ", Frequency: "Trimestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du trimestre" },
                { Code: "012", Appellation: "Liste des titres détenus par les étrangers et MRE", Frequency: "Semestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du semestre" },
                { Code: "013", Appellation: "Rapport du contrôle interne", Frequency: "Semestrielle", Transmission: "SESAM", DeadlineRule: "1 mois après la fin du semestre" },
              ];
              
              const dataCat3 = [
                 	
                { ID: 15, ReportingName: "Notifications des opérations de prêts de titres", Frequency: "Mensuelle", SubmissionMethod: "Envoi électronique", DeadlineRule: "5 jours après la fin du mois" },
                { ID: 16, ReportingName: "Transactions boursières", Frequency: "Mensuelle", SubmissionMethod: "Envoi électronique", DeadlineRule: "5 jours après la fin du mois" },
                { ID: 14, ReportingName: "Indicateurs d'activité", Frequency: "Trimestrielle", SubmissionMethod: "Envoi électronique", DeadlineRule: "1 mois après la fin du trimestre" },              
                { ID: 17, ReportingName: "Rapport du contrôle interne", Frequency: "Semestrielle", SubmissionMethod: "Envoi électronique", DeadlineRule: "1 mois après la fin du semestre" },
              
              ];
              
              /* ---------- Event Generation Function ---------- */
          
              function generateEventsForItem(item, isCat3) {
                var events = [];
                var freq = item.Frequency.toLowerCase().trim();
              
                var rule = item.DeadlineRule.toLowerCase().trim();
                function pushEvent(repDate, deadline) {
                  events.push({
                    code: isCat3 ? item.ID : item.Code,
                    event: isCat3 ? item.ReportingName : item.Appellation,
                    Frequency: item.Frequency,
                    frequencyStyle: applyFrequencyStyle(item.Frequency),
                    Support: isCat3 ? item.SubmissionMethod : item.Transmission,
                    DeadlineRule: item.DeadlineRule,
                    DateArrete: repDate,
                    Deadline: deadline,
                    completed: false,
                    progress: 0,
                    Category: item.Category
                   
                  });
                }

                if (freq === "hebdomadaire") {
    for (let d = new Date(currentYear, 0, 1); d.getFullYear() === currentYear; d.setDate(d.getDate() + 1)) {
      if (d.getDay() === 5) { 
        const deadline = rule.includes("Deuxième jour ouvré") ? addDays(d, 4) : addDays(d, 4);
        pushEvent(new Date(d), deadline);
      }
    }

  } else if (freq === "mensuelle") {
                  for (var m = 0; m < 12; m++) {
                    var rep = new Date(currentYear, m , 0);
                    if ( rule.includes("10 jours après") ) {
                       pushEvent(rep, addDays(rep, 10));
                    } else if ( rule.includes("5 jours après") ) {
                       pushEvent(rep, addDays(rep, 5));
                  }
                }
  } else if (freq === "trimestrielle") {
    const trimestres = [
      new Date(currentYear, 2, 31),
      new Date(currentYear, 5, 30),
      new Date(currentYear, 8, 30),
      new Date(currentYear, 11, 31)
    ];

    trimestres.forEach(ref => {
      let deadline = rule.includes("1 mois") ? new Date(ref.getFullYear(), ref.getMonth() + 1, ref.getDate()) : ref;
      pushEvent(ref, deadline);
    });

  }else if (freq === "semestrielle") {
  const semestres = [
    new Date(currentYear, 5, 30),  // 30 juin - Fin du premier semestre
    new Date(currentYear, 11, 31), // 31 décembre - Fin du deuxième semestre
  ];
  semestres.forEach(ref => {
    let deadline = rule.includes("1 mois") ? new Date(ref.getFullYear(), ref.getMonth() + 1, ref.getDate()) : ref; 
    pushEvent(ref, deadline);
  });
}



  return events;
}
              
              /* ---------- Fonctions de stockage local ---------- */
              function saveProgressForCategory(key, eventsArray) {
                localStorage.setItem(key, JSON.stringify(eventsArray.map(e => ({ completed: e.completed, progress: e.progress }))));
              }
              function loadProgressForCategory(key, eventsArray) {
                var saved = localStorage.getItem(key);
                if (saved) {
                  try {
                    var arr = JSON.parse(saved);
                    if (arr.length === eventsArray.length) {
                      arr.forEach(function(state, i) {
                        eventsArray[i].completed = state.completed;
                        eventsArray[i].progress = state.progress;
                      });
                    }
                  } catch(e) { console.error("Error loading progress:", e); }
                }
              }
          
          /*code ajouter */


          function updateUpcomingTable(tableId, eventsArray) {
              var tbody = document.getElementById(tableId);
              tbody.innerHTML = "";
              var now = new Date();
              var currentMonth = now.getMonth();  // Mois en cours
              var currentYear = now.getFullYear(); // Année en cours
          
              // Initialisation des compteurs pour toutes les catégories
              var reportingsDuMois = 0;
              var reportingsSoumis = 0;
              var enCours = 0;
              var echeancesProches = 0;
          
              // Filtrer les événements pour ceux dont la Deadline est dans les 30 prochains jours
              var filtered = eventsArray.filter(function(e) { 
                  return (e.Deadline instanceof Date && e.Deadline > now && e.Deadline <= addDays(now, 30)); 
              });
          
              // Mise à jour des compteurs pour chaque événement dans filtered
              filtered.forEach(function(e) {
                  // Mise à jour des compteurs pour chaque événement en fonction de la Deadline et de la catégorie
                  if (e.Deadline.getMonth() === currentMonth && e.Deadline.getFullYear() === currentYear) {
                      reportingsDuMois++;  // Compte les événements du mois
                  }
          
                  // Calcul des jours restants
                  var daysRemaining = Math.ceil((e.Deadline - now) / (1000 * 60 * 60 * 24)); // Calcul des jours restants
                  if (daysRemaining <= 7) {
                      echeancesProches++;  // Compte les événements avec échéances proches (<= 7 jours)
                  }
          
                  // Mise à jour des compteurs en fonction du statut de l'événement
                  if (e.status === "soumis") {
                      reportingsSoumis++;  // Compte les événements soumis
                  } else {
                      enCours++;  // Compte les événements en cours
                  }
              });
          
              // Trier les événements par date de Deadline
              filtered.sort(function(a, b) { return a.Deadline - b.Deadline; });
          
              // Créer les lignes du tableau avec les événements filtrés
              filtered.forEach(function(e) {
                  var tr = document.createElement("tr");
          
                  // Ajouter les colonnes pour chaque propriété de l'événement
                  ["code", "event", "Frequency", "Support", "DeadlineRule"].forEach(function(prop) {
                      var td = document.createElement("td");
                      if (prop === "Frequency") {
                          td.textContent = e[prop];
                          td.classList.add(applyFrequencyStyle(e[prop]));
                      } else {
                          td.textContent = e[prop];
                      }
                      tr.appendChild(td);
                  });
          
                  // Ajouter la colonne DateArrete
                  var tdArrete = document.createElement("td");
                  tdArrete.textContent = formatDate(e.DateArrete);
                  tr.appendChild(tdArrete);
          
                  // Ajouter la colonne Deadline
                  var tdDeadline = document.createElement("td");
                  tdDeadline.textContent = e.Deadline ? formatDate(e.Deadline) : "N/A";
                  tr.appendChild(tdDeadline);
          
                  // Ajouter la colonne Days Remaining
                  var tdDays = document.createElement("td");
                  if (e.Deadline instanceof Date) {
                      var daysRemaining = Math.ceil((e.Deadline - now) / (1000 * 60 * 60 * 24)); // Calcul des jours restants
                      tdDays.textContent = daysRemaining;
                  } else {
                      tdDays.textContent = "N/A";
                  }
                  tr.appendChild(tdDays);
          
                  // Ajouter la ligne au tableau
                  tbody.appendChild(tr);
              });
          
              // Mise à jour des compteurs dans les cards après la boucle
              document.getElementById("reportings-du-mois").textContent = reportingsDuMois;
              document.getElementById("reportings-soumis").textContent = reportingsSoumis;
              document.getElementById("en-cours").textContent = enCours;
              document.getElementById("echeances-proches").textContent = echeancesProches;
          }
          
                    
          
          
              function updateReportsTable(tableId, eventsArray, storageKey) {
                var tbody = document.getElementById(tableId);
                tbody.innerHTML = "";
                var now = new Date();
                var sorted = eventsArray.slice().sort(function(a, b) {
                  var aDays = (a.Deadline instanceof Date) ? (a.Deadline - now) : Infinity;
                  var bDays = (b.Deadline instanceof Date) ? (b.Deadline - now) : Infinity;
                  return aDays - bDays;
                });
                sorted.forEach(function(e) {
                  var tr = document.createElement("tr");
                  var tdCode = document.createElement("td");
                  tdCode.textContent = e.code;
                  tr.appendChild(tdCode);
                  var tdEvent = document.createElement("td");
                  tdEvent.textContent = e.event;
                  tr.appendChild(tdEvent);
                  var tdFreq = document.createElement("td");
                  tdFreq.textContent = e.Frequency;
                  tr.appendChild(tdFreq);
                  var tdSupport = document.createElement("td");
                  tdSupport.textContent = e.Support;
                  tr.appendChild(tdSupport);
                  var tdRule = document.createElement("td");
                  tdRule.textContent = e.DeadlineRule;
                  tr.appendChild(tdRule);
                  var tdArrete = document.createElement("td");
                  tdArrete.textContent = formatDate(e.DateArrete);
                  tr.appendChild(tdArrete);
                  var tdDeadline = document.createElement("td");
                  tdDeadline.textContent = e.Deadline ? formatDate(e.Deadline) : "N/A";
                  tr.appendChild(tdDeadline);
                  var tdDays = document.createElement("td");
                  if (e.Deadline instanceof Date)
                    tdDays.textContent = Math.ceil((e.Deadline - now) / (1000 * 60 * 60 * 24));
                  else
                    tdDays.textContent = "N/A";
                  tr.appendChild(tdDays);
                  var tdToggle = document.createElement("td");
                  var checkbox = document.createElement("input");
                  checkbox.type = "checkbox";
                  checkbox.className = "toggle-checkbox";
                  checkbox.checked = e.completed;
                  checkbox.addEventListener("change", function() {
                    e.completed = checkbox.checked;
                    e.progress = checkbox.checked ? 100 : 0;
                    saveProgressForCategory(storageKey, eventsArray);
                    updateReportsTable(tableId, eventsArray, storageKey);
                    updateProgressOverview();
                  });
                  tdToggle.appendChild(checkbox);
                  tr.appendChild(tdToggle);
                  var tdProgress = document.createElement("td");
                  tdProgress.textContent = e.progress + "%";
                  tr.appendChild(tdProgress);
                  tbody.appendChild(tr);
                });
              }
              
              function updateProgressOverview() {
                function plotCategoryProgress(categoryName, eventsArray, containerId, color) {
                  var group = {};
                  eventsArray.forEach(function(e) {
                    if (!group[e.event]) { group[e.event] = { total: 0, completed: 0 }; }
                    group[e.event].total++;
                    if (e.completed) group[e.event].completed++;
                  });
                  var reportingNames = [], percentages = [];
                  for (var rep in group) {
                    reportingNames.push(rep);
                    percentages.push((group[rep].completed / group[rep].total) * 100);
                  }
                  var data = [{
                    type: 'bar',
                    x: percentages,
                    y: reportingNames,
                    orientation: 'h',
                    marker: { color: color }
                  }];
                  var layout = { title: categoryName + " Progression Overview (Yearly Completion %)", margin: { l: 200, r: 50, t: 50, b: 50 } };
                  Plotly.newPlot(containerId, data, layout);
                }
                plotCategoryProgress("I – Reporting AMMC BCP", eventsCat1, "progress-bars-cat1", "rgba(55,128,191,0.6)");
                plotCategoryProgress("II – Reporting AMMC BCP2S", eventsCat2, "progress-bars-cat2", "rgba(50,171,96,0.6)");
                plotCategoryProgress("III – Reporting AMMC ALYOUSR", eventsCat3, "progress-bars-cat3", "rgba(219,64,82,0.6)");
              }
              
              /* ---------- Variables globales et updateAll() ---------- */
              var currentYear = parseInt(document.getElementById("yearSelector").value);
              var eventsCat1 = [];
              var eventsCat2 = [];
              var eventsCat3 = [];
              function updateAll() {
                currentYear = parseInt(document.getElementById("yearSelector").value);
                eventsCat1 = [];
                dataCat1.forEach(function(item) {
                  item.Category = "I – Reporting AMMC BCP";
                  eventsCat1 = eventsCat1.concat(generateEventsForItem(item, false));
                });
                eventsCat2 = [];
                dataCat2.forEach(function(item) {
                  item.Category = "II – Reporting AMMC BCP2S";
                  eventsCat2 = eventsCat2.concat(generateEventsForItem(item, false));
                });
                eventsCat3 = [];
                dataCat3.forEach(function(item) {
                  item.Category = "III – Reporting AMMC ALYOUSR";
                  eventsCat3 = eventsCat3.concat(generateEventsForItem(item, true));
                });
                loadProgressForCategory("progressCat1_" + currentYear, eventsCat1);
                loadProgressForCategory("progressCat2_" + currentYear, eventsCat2);
                loadProgressForCategory("progressCat3_" + currentYear, eventsCat3);
                updateUpcomingTable("upcoming-table-cat1", eventsCat1);
                updateReportsTable("reports-table-cat1", eventsCat1, "progressCat1_" + currentYear);
                updateUpcomingTable("upcoming-table-cat2", eventsCat2);
                updateReportsTable("reports-table-cat2", eventsCat2, "progressCat2_" + currentYear);
                updateUpcomingTable("upcoming-table-cat3", eventsCat3);
                updateReportsTable("reports-table-cat3", eventsCat3, "progressCat3_" + currentYear);
                updateProgressOverview();
                populateReportSelect();
              }
              
              /* ---------- Remplissage du select de rapports ---------- */
              function populateReportSelect() {
                var select = document.getElementById("reportSelect");
                select.innerHTML = "";
                var reports = {};
                [eventsCat1, eventsCat2, eventsCat3].forEach(function(arr) {
                  arr.forEach(function(e) { reports[e.event] = true; });
                });
                for (var rep in reports) {
                  var option = document.createElement("option");
                  option.value = rep;
                  option.textContent = rep;
                  select.appendChild(option);
                }
              }
              
              /* ---------- Marquer un report comme déposé ---------- */
              function markReportUploaded(reportName, selectedMonth) {
                var marked = false;
                [eventsCat1, eventsCat2, eventsCat3].forEach(function(arr) {
                  arr.forEach(function(e) {
                    if (e.event === reportName && e.Deadline instanceof Date &&
                        e.Deadline.getMonth() === selectedMonth && e.Deadline.getFullYear() === currentYear) {
                      e.completed = true;
                      e.progress = 100;
                      marked = true;
                    }
                  });
                });
                if (marked) {
                  saveProgressForCategory("progressCat1_" + currentYear, eventsCat1);
                  saveProgressForCategory("progressCat2_" + currentYear, eventsCat2);
                  saveProgressForCategory("progressCat3_" + currentYear, eventsCat3);
                  updateAll();
                }
              }
              
            /* ---------- Upload de fichier ---------- */
            document.getElementById("uploadButton").addEventListener("click", function() {
                var reportSelect = document.getElementById("reportSelect");
                var selectedReport = reportSelect.value;
                var monthSelect = document.getElementById("monthSelect");
                var selectedMonth = parseInt(monthSelect.value);
                var fileInput = document.getElementById("fileInput");
                var file = fileInput.files[0];
                if (!file) {
                  document.getElementById("uploadStatus").textContent = "Please select a file.";
                  return;
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                  var base64Data = e.target.result;
                  google.colab.kernel.invokeFunction('upload_file', [selectedReport, currentYear, selectedMonth, file.name, base64Data], {})
                    .then(function(result) {
                      document.getElementById("uploadStatus").textContent = result.data;
                      markReportUploaded(selectedReport, selectedMonth);
                    })
                    .catch(function(err) {
                      document.getElementById("uploadStatus").textContent = "Upload failed.";
                      console.error(err);
                    });
                };
                reader.readAsDataURL(file);
              });
          
            </script>
          <script>
            document.getElementById("uploadButton").addEventListener("click", function () {
                let reportName = document.getElementById("reportSelect").value;
                let year = document.getElementById("yearSelector").value;
                let month = document.getElementById("monthSelect").value;
                let fileInput = document.getElementById("fileInput").files[0];
          
                if (!fileInput) {
                    alert("Veuillez sélectionner un fichier !");
                    return;
                }
          
                let formData = new FormData();
                formData.append("report_name", reportName);
                formData.append("year", year);
                formData.append("month", month);
                formData.append("file", fileInput);
          
                fetch("/upload/", {
                    method: "POST",
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert("Erreur : " + data.error);
                    } else {
                        alert("Fichier uploadé avec succès !");
                        console.log("File saved at:", data.file_path);
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de l'upload :", error);
                    alert("Une erreur est survenue !");
                });
            });
          
                /* ---------- Initialisation ---------- */
              document.getElementById("updateYearButton").addEventListener("click", updateAll);
              updateAll();
              document.getElementById("defaultSubTab_cat1").click();
              document.getElementById("defaultSubTab_cat2").click();
              document.getElementById("defaultSubTab_cat3").click();
              
              setInterval(function() {
                updateUpcomingTable("upcoming-table-cat1", eventsCat1);
                updateReportsTable("reports-table-cat1", eventsCat1, "progressCat1_" + currentYear);
                updateUpcomingTable("upcoming-table-cat2", eventsCat2);
                updateReportsTable("reports-table-cat2", eventsCat2, "progressCat2_" + currentYear);
                updateUpcomingTable("upcoming-table-cat3", eventsCat3);
                updateReportsTable("reports-table-cat3", eventsCat3, "progressCat3_" + currentYear);
                updateProgressOverview();
              }, 60000);
          
          
              function applyFrequencyStyle(frequency) {
            switch(frequency) {
              case "Mensuelle":
                return "freq-monthly"; // Classe CSS pour la fréquence mensuelle

              case "Semestrielle":
                return "freq-semester"; // Classe CSS pour la fréquence semestrielle

              case "Annuelle":
                return "freq-annual"; // Classe CSS pour la fréquence annuelle
                case "Trimestrielle":
                return "freq-trimestre"; // Classe CSS pour la fréquence trimestrielle
                case "Hebdomadaire":
                return "freq-hebdomadaire";

              default:
                return "freq-default"; // Classe CSS par défaut
            }
          }
          </script>

<script src="script.js"></script>

</body>
</html>
